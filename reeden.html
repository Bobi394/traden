<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mit Anfrage-ID einloggen & Chatten</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto;max-width:900px;margin:20px auto;padding:12px}
    #chat{border:1px solid #ddd;padding:10px;height:360px;overflow:auto;background:#fafafa;margin-top:10px}
    .msg{margin:6px 0;padding:6px;border-radius:6px}
    .me{background:#e0ffd8}
    .other{background:#fff}
  </style>
</head>
<body>
  <h1>Trading Chat üí¨</h1>
  <p>Gib deine <b>Anfrage-ID</b> ein, um in den Chat zu kommen (nur wenn deine Anfrage akzeptiert wurde).</p>

  <input id="idInput" placeholder="Deine Anfrage-ID"/>
  <input id="nameInput" placeholder="Dein Roblox Name"/>
  <button id="joinBtn">Einloggen üîê</button>

  <div id="status"></div>

  <div id="chat" style="display:none"></div>
  <div id="composer" style="display:none;margin-top:8px">
    <input id="msgInput" placeholder="Nachricht..." style="width:75%"/>
    <button id="sendBtn">Senden</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    // Deine Firebase Config üî•
    const firebaseConfig = {
      apiKey: "AIzaSyAJO1E-U1VCQRXlMjHUrP5312ozqH2gL6w",
      authDomain: "traden-996a7.firebaseapp.com",
      databaseURL: "https://traden-996a7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "traden-996a7",
      storageBucket: "traden-996a7.firebasestorage.app",
      messagingSenderId: "891291590181",
      appId: "1:891291590181:web:b3738e6144a685728d69cc",
      measurementId: "G-2BT2JP06XH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentId=null;
    let robloxName=null;
    let chatRef=null;

    document.getElementById('joinBtn').onclick=async()=>{
      currentId=document.getElementById('idInput').value.trim();
      robloxName=document.getElementById('nameInput').value.trim();
      if(!currentId||!robloxName)return alert('Bitte ID und Namen eingeben!');
      const snap=await db.ref('requests/'+currentId).get();
      if(!snap.exists()) return alert('‚ùå Keine Anfrage mit dieser ID gefunden.');
      const data=snap.val();
      if(data.status!=='accepted'){
        document.getElementById('status').textContent='‚ùå Deine Anfrage wurde noch nicht akzeptiert.';
        return;
      }
      document.getElementById('status').textContent='‚úÖ Willkommen, '+robloxName+'! Deine Anfrage ist akzeptiert.';
      startChat();
    };

    function startChat(){
      document.getElementById('chat').style.display='';
      document.getElementById('composer').style.display='';
      chatRef=db.ref('chats/'+currentId+'/messages');

      chatRef.on('value',snap=>{
        const chat=document.getElementById('chat');
        chat.innerHTML='';
        const v=snap.val()||{};
        Object.keys(v).forEach(k=>{
          const m=v[k];
          const div=document.createElement('div');
          div.className='msg '+(m.from===robloxName?'me':'other');
          div.innerHTML='<b>'+m.from+':</b> '+m.text;
          chat.appendChild(div);
        });
        chat.scrollTop=chat.scrollHeight;
      });

      document.getElementById('sendBtn').onclick=async()=>{
        const t=document.getElementById('msgInput').value.trim();
        if(!t)return;
        await chatRef.push({from:robloxName,text:t,ts:Date.now()});
        document.getElementById('msgInput').value='';
      };
    }
  </script>
</body>
</html>